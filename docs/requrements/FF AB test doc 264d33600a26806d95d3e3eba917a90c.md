# FF AB test doc

Created by: Andy
Created time: September 4, 2025 1:15 PM
Last edited by: Andy
Last updated time: September 4, 2025 1:16 PM

# **Fast Fish AB Test — Pipeline Readiness Spec (v2, English Only)**

A single source of truth for what the pipeline **must** do for the September A/B pilot to be valid. No tables; every item is action‑oriented and testable.

---

## **0) Purpose & Scope**

- **Purpose**: Ship a repeatable pipeline that outputs **store‑level assortments** optimised for **sell‑through** and safe under constraints, and proves value in a September A/B test.
- **Region**: **East** only. Pilot cluster must be **moderate temperature** to reflect typical September demand (avoid winter skew).
- **Category**: **Pants** first (women’s leisure as the initial focus). Other categories may remain in the dataset for clustering context but should not surface in v1 recommendations.
- **Forecast horizon**: **One‑month look‑ahead** (September).
- **Launch window**: **Before mid‑September** to avoid National Day volatility.

---

## **1) Launch Governance & Cadence**

- **Daily progress updates** from now until go‑live (1–2 short bullets + file drops / blockers).
- **Dataset freeze**: Freeze the September pilot dataset immediately after QA passes; no schema changes post‑freeze.
- **Next checkpoint**: Lock pilot cluster and roster; confirm store‑level output format; set **go‑live date** (< Sep 15).
- **Runbook**: Provide an A/B **runbook** that defines file paths, validation steps, and read‑out rules.

---

## **2) Go/No‑Go Acceptance Criteria (Must‑Haves)**

The A/B **cannot** launch unless **all** are true:

1. **Clean September data**: synthetic/sample data purged; F/B (front/back) ratio bug fixed; sell‑through units standardised; data dictionary updated.
2. **Temperature features & zones**: 2–3 years of Jul–Sep daily series ingested; features computed; ~6 zones labelled and written to store tags; QC shows meaningful separation.
3. **September Gap‑Analysis workbook** delivered and validated on five axes (category, display, season, gender, price) with corrected F/B ratios.
4. **Pilot cluster locked**: East‑region, moderate‑temp cluster chosen; silhouette ≥ **0.50** (≥0.40 acceptable only with written rationale); cluster portraits in business language provided.
5. **Roster & mapping**: Approved East‑region store roster; **store→cluster→temp‑zone** mapping file with legend delivered.
6. **Allocation to stores**: Group deltas decomposed to **integer per‑store** quantities with **100% reconciliation** and per‑store caps/baselines enforced.
7. **Output Spec v2** implemented (see §6): optimisation target, current/target/Δ sell‑through, constraint status, confidence & trade‑off, run IDs, valid‑until; **English‑only headers**.
8. **Plain‑language glossary** delivered (how temp zones are derived; clustering features including weather/style/size; why new “key regions” replace legacy regions).
9. **Readiness evidence** packaged (see §12).
10. **Client inputs received** (latest East‑region store list; 48‑hour SLA on reviews) and acknowledged.

---

## **3) Data Standards & Hygiene (What the pipeline must implement)**

**Mapping & integrity**

- Fix **Target_Style_Tags ↔ Gender** mismatches; ship an authoritative mapping and pass unit tests.
- Fix **Target_Style_Tags ↔ Display_Location** label collisions; tests must show 100% joinability (no unresolved labels).
- Validate **Store_Codes_In_Group** (format/completeness); repair or replace sources so all group codes resolve to known stores.
- Backfill/compute **trend fields**; target <1% missing.

**Sell‑through units & invariants**

- Canonical unit for sell‑through is **fraction [0–1]**; percentage fields appear only as *_Pct.
- Add **normalisation guardrails** on merges; log and correct unit drift automatically.
- CI tests: *_Frac ≤ 1 and *_Pct ≤ 100; no sell‑through field >1.
- Align **Fashion/Basic** ratios across store/cluster/SPU levels; prefer **amounts-first** precedence, with quantity fallback at cluster; unit tests must cover ranges & precedence.
- Enforce **ΔQty** invariants: integer values, ±20% cap (min ±1), Target ≥ 0, and ΔQty = Target − Current identity across all rows.

**Front/Back (F/B) display ratio**

- Correct calculation and labels for front/back display; re‑compute fields and review against three sample groups.

**Data dictionary**

- Update the dictionary to reflect all units, thresholds, precedence rules, and cross‑file references used in this pilot.

---

## **4) Temperature Features & Zone Labelling**

- Pull **Q3 daily temperatures** (2–3 years) per store location.
- Compute features: mean_Q3, sd_Q3, amplitude (max–min), %days>28°C, Sep–Jul delta, 7‑day volatility.
- Derive **quantile‑based** temperature zones (~6), then **write labels** into store tag files.
- Run a **separation & impact QC** to show the new temp features improve cluster separation vs. baseline.

---

## **5) Gap‑Analysis Workbook (September)**

- Ensure **Autumn/Winter SKUs** relevant to September are included in the analysis input (do not bias toward heavy winter in outputs).
- Segment outputs by **five label dimensions**: major/minor category, display location, season, gender, **price band**.
- Produce **group‑level recommendations** CSV driven by gaps.
- Deliver an **executive gap report** (short deck or narrative) highlighting ≥3 representative clusters.

---

## **6) Clustering Requirements & Deliverables**

**Feature completeness**

- Climate/temperature zone ✅.
- **Store‑type / style**: create a column with **Fashion / Basic / Balanced** using existing ratios; persist on the store table; include in clustering.
- **Capacity / size tier**: infer Small / Medium / Large from fixture data or a sales×SKU breadth proxy; include in clustering and rules.

**Interpretability & stability**

- Provide a **cluster portraits** deck per cluster in business language (style, capacity, temp, exemplar stores, top SKUs).
- Generate **feature‑importance** artefacts (e.g., Gini/Permutation/SHAP) and exemplar stores.
- Report **silhouette**; target ≥0.50. If 0.40–0.49, include a mitigation note.
- Add a **stability check** vs the prior run (drift % of assignments).

**Regional guardrails & bias checks**

- Pilot cluster must be **entirely East region**; provide a full **store→cluster→zone** map.
- Run a **store‑size mix** spot‑check to ensure the cluster is not biased toward only large or only small stores; tag store size in outputs.

**Roster & A/B setup**

- Produce **store tags CSV** with complete store‑level detail (group + all tags).
- Deliver **final store roster** with experimental/control flags for A/B.
- Document **clustering logic** and provide a **new vs legacy** comparison.

---

## **7) Store‑Level Recommendation & Allocation**

- **Decomposition**: Allocate group ΔQty down to **per‑store integers** using a formula such as sales^α × capacity^β × suitability^γ; reconcile to 100%.
- **Caps & baselines**: Apply per‑store caps and ensure mandated baseline presence is non‑zero.
- **Seasonal guardrail**: Avoid heavy winter products in September unless strong demand signals justify inclusion; any inclusion must carry a rationale string.
- **CLI + manifest**: Wire into the run script with parameters documented; provide a manifest and README.

---

## **8) Output Specification (v2)**

**Files**

- store_level_recommendations_allocated_*.csv (+ reconciliation JSON and rationale fields).
- store_roster_ab.csv (store ID, cluster ID, temp‑zone label, store‑size tag, exp/control).
- unified_delivery_202509A|B.csv/.xlsx (preferred single feed after Step 34 builder).

**Required columns** (English‑only headers)

- Optimization_Target = "Maximize Sell‑Through Rate Under Constraints".
- Current_ST_Pct, Target_ST_Pct, Delta_ST_Pct (first three columns after IDs where possible).
- Capacity_Utilization_Pct, Store_Type_Alignment, Temperature_Suitability, and an overall Constraint_Status (OK / Warning / Blocked).
- Confidence_Score (0–1) and concise Trade_Off_Note.
- Valid_Until_Month, Run_ID, Spec_Version.
- Product descriptors de‑concatenated into separate columns (no opaque tag strings).
- **Per‑store integer quantities only**; no floats.

---

## **9) KPI Alignment & Optimisation Path**

- **Unified objective**: Every rule and score used for ranking must align to **predicted sell‑through** uplift (under constraints). Replace revenue/Z‑score driven decisions where they conflict.
- **Sparse‑data safeguards**: When history is thin, apply a conservative floor (e.g., ≥1 unit/day across 15 days) to avoid over‑buying.
- **Rule retargeting**: “Missing category”, “imbalance”, “below minimum”, “over‑capacity”, “missed sales”, “performance gap” rules should act **only** when they **increase predicted sell‑through**.
- **Solver (optional for pilot)**: A MILP/LP solver is desirable but **not required** for pilot validity. Keep the spec drafted; integrate post‑pilot.

---

## **10) Scope Guardrails (Pilot)**

- **Region**: East only; pilot cluster in a **moderate temp** zone.
- **Category**: **Pants** focus; other categories retained only for clustering context.
- **Seasonality**: September outputs must not be winter‑heavy unless justified with rationale and constraint checks.

---

## **11) Transparency & Definitions**

- Deliver a **plain‑language glossary** that explains: temp‑zone derivation, climate features, store‑type/style rules, size tiers, and the rationale for new key regions replacing legacy “arbitrary” regions.
- Provide a **clustering logic doc** with feature list, parameter choices, and a comparison against the legacy approach.

---

## **12) Evidence Package (Sign‑Off Artifacts)**

- Logic & algorithm notes (glossary + clustering doc).
- Feature‑importance and cluster comparison visuals.
- Store‑group portrait deck.
- September Gap‑Analysis workbook and CSVs.
- Example **store‑level** output + specification.
- (Optional) Short demo recording showing the file build and validation checks.

---

## **13) Operational Plan & Responsibilities**

- **Daily updates**: short text or email with a list of drops/fixes/risks.
- **Follow‑up meeting**: confirm data fixes, review clusters, decide tweaks if any.
- **Set the A/B start date** immediately after cluster & store‑level file approval.

---

## **14) Client Inputs & Dependencies**

- Latest **East‑region store list** (IDs and open/close status) — **ASAP**.
- Timely **review** of the Gap‑Analysis and cluster portraits (48‑hour SLA) to keep the schedule.

---

## **15) Risks & Mitigations**

- **Late data fixes** → Freeze dataset after QA; defer non‑critical changes.
- **Cluster instability** → Produce a stability report; allow only tweaks that keep silhouette ≥0.50 or include a mitigation note when 0.40–0.49.
- **Store‑level over‑allocation** → Enforce caps, reconciliation, and explicit flags for small‑store overloads.
- **Objective drift** → CI tests that assert presence and ranges of all sell‑through fields; fail the build on violations.

---

## **16) QA & CI Checks (Explicit)**

- Unit tests for all mapping fixes (gender/display ↔ style tags) must pass.
- CI rules enforcing sell‑through scaling (Frac ≤1, Pct ≤100) and F/B ratio recomputation.
- Validation script that checks: integer quantities, 100% reconciliation, required columns present, no nulls in IDs, Delta_ST_Pct computed.
- Sanity checks for temperature‑zone coverage (≥95% of stores have a label).
- Spot‑check report on store‑size mix within the pilot cluster.

---

## **17) De‑Prioritised (May Slip Post‑Pilot)**

- Detailed capacity modelling beyond size tiers; interactive dashboards; auto‑weight learner; full MILP solver + live what‑if API. Keep specifications written for rapid follow‑on.

---

## **18) Final Sign‑Off Checklist (Tick‑to‑Green)**

- September dataset clean; F/B fixed; sell‑through units standardised; dictionary updated.
- Temperature features computed; ~6 zones labelled and written to tags; QC passed.
- September Gap‑Analysis delivered across 5 axes with group‑level recs.
- Pilot cluster locked (East, moderate temp); portraits + silhouette report delivered; bias check passed.
- East store roster approved; store→cluster→zone mapping file with legend delivered.
- Store‑level allocation CSV with per‑store **integers**; caps applied; reconciliation = 100%; CLI + manifest ready.
- Output Spec v2 present (optimisation target, ST metrics, constraints, confidence, IDs & versioning; English‑only headers).
- Glossary + clustering logic doc + runbook delivered.
- Evidence package assembled; go‑live date set **before Sep 15**.

— End of v2 —